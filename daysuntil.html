<!DOCTYPE html>
<html>
    <head>
        <title>com.krabs.daysuntil.action</title>
        <meta charset="utf-8" />
    </head>
    <body>
        <script>
            let websocket = null;
            let pluginUUID = null;
            let actionInfo = {};
            let DestinationEnum = Object.freeze({ HARDWARE_AND_SOFTWARE: 0, HARDWARE_ONLY: 1, SOFTWARE_ONLY: 2 });
            var settingsCache = {};
            var base64Img = null;
// Beginning of let KrabsDaysUntil definition
            let KrabsDaysUntil = {
                type: "com.krabs.daysuntil.action",
                onKeyDown: function (context, settings, coordinates, userDesiredState) {
                    /* Code here will run when the key is pressed https://developer.elgato.com/documentation/stream-deck/sdk/events-received/#keydown */
                },
                onKeyUp: function (context, settings, coordinates, userDesiredState) {
                    /* Code here will run when the key is released https://developer.elgato.com/documentation/stream-deck/sdk/events-received/#keyup */
                    settingsCache[context] = settings;
                },
                fKrabs_DaysUntil: function (context, settings) {
                    var payload = settingsCache[context];
                    var vEventName_Line1 = payload['vKrabs_EventName'];
                    var vEventName_Line2 = payload['vKrabs_EventName2'];
                    if (payload != null && payload.hasOwnProperty('vKrabs_EventDate')) {
                      var vEventDate = payload['vKrabs_EventDate'];
                    }

                    function getData() {
                      var payload = settingsCache[context];
                      var vEventName_Line1 = payload['vKrabs_EventName'];
                      var vEventName_Line2 = payload['vKrabs_EventName2'];
                      if (payload != null && payload.hasOwnProperty('vKrabs_EventDate')) {
                        var vEventDate = payload['vKrabs_EventDate'];
                      }

                      vDate_Future = new Date(new Date(vEventDate));
                      vDate_Now = new Date();

                      vSeconds = Math.floor((vDate_Future - (vDate_Now))/1000);
                      vMinutes = Math.floor(vSeconds/60);
                      vHours = Math.floor(vMinutes/60);
                      vDays = Math.floor(vHours/24);

                      vHours = vHours-(vDays*24);
                      vMinutes = vMinutes-(vDays*24*60)-(vHours*60);
                      vSeconds = vSeconds-(vDays*24*60*60)-(vHours*60*60)-(vMinutes*60);
                      //console.warn("Days: ", (vDays+1));
                      var vDisplay_vEventName_Line1 = vEventName_Line1
                      var vDisplay_vEventName_Line2 = vEventName_Line2
                      var vDisplay_TimeLeft = (vDays+1)
                      if (vDisplay_TimeLeft > 0) {
                        KrabsDaysUntil.SetTitle(context, "");
                        var inState = 0
                        setState(context, inState);
                        var imageUrl = "resources/images/actionDefaultImage.png";
                        convertImgToBase64_text(imageUrl, vDisplay_vEventName_Line1, vDisplay_vEventName_Line2, vDisplay_TimeLeft, function(base64Img){
                        var vAvatarBase64 = base64Img;
                        setImage(context, vAvatarBase64);
                        });
                      } else if (vDisplay_TimeLeft == 0) {
                        KrabsDaysUntil.SetTitle(context, "");
                        var inState = 1
                        setState(context, inState);
                        var imageUrl = "resources/images/tday.png";
                        convertImgToBase64_text(imageUrl, vDisplay_vEventName_Line1, vDisplay_vEventName_Line2, vDisplay_TimeLeft, function(base64Img){
                        var vAvatarBase64 = base64Img;
                        setImage(context, vAvatarBase64);
                        });
                      } else {
                        KrabsDaysUntil.SetTitle(context, "");
                        var inState = 1
                        setState(context, inState);
                        var imageUrl = "resources/images/expired.png";
                        convertImgToBase64_text(imageUrl, vDisplay_vEventName_Line1, vDisplay_vEventName_Line2, vDisplay_TimeLeft, function(base64Img){
                        var vAvatarBase64 = base64Img;
                        setImage(context, vAvatarBase64);
                        });
                        KrabsDaysUntil.SetTitle(context, "Expired!");
                      }
                    }
                  getData();
                  setTimeout(function run() {
                    getData();
                    var payload = settingsCache[context];
                    var vEventName_Line1 = payload['vKrabs_EventName'];
                    var vEventName_Line2 = payload['vKrabs_EventName2'];
                    if (payload != null && payload.hasOwnProperty('vKrabs_EventDate')) {
                      var vEventDate = payload['vKrabs_EventDate'];
                    }
                    setTimeout(run, 1000);
                  }, 1000);
                },
                // End of fKrabs_DaysUntil function

                onWillAppear: function (context, settings, coordinates) {
                    /* Code here will run when the Stream Deck application is opened, the user switches between profiles or when a user adds the action
                        to their Stream Deck https://developer.elgato.com/documentation/stream-deck/sdk/events-received/#willappear
                    */
                    console.log("onWillAppear context: ", context, " settings: ", settings);
                    settingsCache[context] = settings;
                    var payload = settingsCache[context];
                    KrabsDaysUntil.fKrabs_DaysUntil(context, settings);
                },
                onWillDisappear: function (context, settings, coordinates) {
                    console.log("onWillDisappear context: ", context, " settings: ", settings);
                },
                SetTitle: function (context, vAnswer) {
                    let json = { event: "setTitle", context: context, payload: { title: ""+ vAnswer, target: DestinationEnum.HARDWARE_AND_SOFTWARE } };
                    websocket.send(JSON.stringify(json));
                },
                getSettings: function (context, payload) {
                    websocket.send(context, 'getSettings', {});
                    console.log(settings)
                },
                SetSettings: function (context, settings) {
                    var json = {
                        "event": "setSettings",
                        "context": context,
                        "payload": settings
                    };

                    websocket.send(JSON.stringify(json));
                    settingsCache[context] = settings;
                    console.log("New Settings", settings);
                    console.log("New JSON", JSON.stringify(json));
                },
                didReceiveSettings: function (context, payload) {
                  console.log("Did receive: ", settings)
                }
            };
// End of let KrabsDaysUntil definition
            function canvasShake(context) {
              function fShake(context, vPosX, vPosY, vRotate) {
                var imageUrl = "resources/images/actionDefaultImage.png";
                convertImgToBase64_motion(imageUrl, vPosX, vPosY, vRotate, function(base64Img){
                var vAvatarBase64 = base64Img;
                setImage(context, vAvatarBase64);
                });
              };
              setTimeout(function() { fShake(context,3,1,0) }, 100);
              setTimeout(function() { fShake(context,0,0,0) }, 200);
              setTimeout(function() { fShake(context,-5,-2,0) }, 300);
              setTimeout(function() { fShake(context,6,1,0) }, 400);
              setTimeout(function() { fShake(context,-3,0,0) }, 500);
              setTimeout(function() { fShake(context,1,2,0) }, 600);
              setTimeout(function() { fShake(context,0,-1,0) }, 700);
              setTimeout(function() { fShake(context,-2,0,0) }, 800);
              setTimeout(function() { fShake(context,4,2,0) }, 900);
              setTimeout(function() { fShake(context,0,0,0) }, 1000);
            };

            function convertImgToBase64_text(url, vDisplay_vEventName_Line1, vDisplay_vEventName_Line2, vDisplay_TimeLeft, callback, outputFormat){
              var canvas = document.createElement('CANVAS');
              var ctx = canvas.getContext('2d');
              var img = new Image;
              img.crossOrigin = 'Anonymous';
              img.onload = function(){
                  canvas.height = img.height;
                  canvas.width = img.width;
                    ctx.drawImage(img,0,0);
                    // Text, width, height
                    if (vDisplay_TimeLeft > 0) {
                      ctx.font = "bold 13px Arial";
                      ctx.fillStyle = 'white';
                      ctx.textAlign = 'center';
                      ctx.fillText("Days Until", 36, 12);

                      ctx.font = "28px Impact";
                      ctx.fillStyle = 'black';
                      ctx.textAlign = 'center';
                      ctx.fillText("+" + vDisplay_TimeLeft, 36, 43);

                      if (vDisplay_vEventName_Line1 && vDisplay_vEventName_Line2) {
                        ctx.font = "bold 13px Arial";
                        ctx.fillStyle = '#d00000';
                        ctx.textAlign = 'center';
                        ctx.fillText(vDisplay_vEventName_Line1, 36, 56);

                        ctx.font = "bold 13px Arial";
                        ctx.fillStyle = '#d00000';
                        ctx.textAlign = 'center';
                        ctx.fillText(vDisplay_vEventName_Line2, 36, 68);

                      } else if (vDisplay_vEventName_Line1 && !vDisplay_vEventName_Line2) {
                        ctx.font = "bold 13px Arial";
                        ctx.fillStyle = '#d00000';
                        ctx.textAlign = 'center';
                        ctx.fillText(vDisplay_vEventName_Line1, 36, 60);

                      } else if (!vDisplay_vEventName_Line1 && vDisplay_vEventName_Line2) {
                        ctx.font = "bold 13px Arial";
                        ctx.fillStyle = '#d00000';
                        ctx.textAlign = 'center';
                        ctx.fillText(vDisplay_vEventName_Line2, 36, 60);
                      }

                    } else if (vDisplay_TimeLeft == 0) {
                      if (vDisplay_vEventName_Line1 && vDisplay_vEventName_Line2) {
                        ctx.font = "bold 13px Arial";
                        ctx.fillStyle = '#fea711';
                        ctx.textAlign = 'center';
                        ctx.fillText(vDisplay_vEventName_Line1, 36, 56);

                        ctx.font = "bold 13px Arial";
                        ctx.fillStyle = '#fea711';
                        ctx.textAlign = 'center';
                        ctx.fillText(vDisplay_vEventName_Line2, 36, 68);
                      } else if (vDisplay_vEventName_Line1 && !vDisplay_vEventName_Line2) {
                        ctx.font = "bold 13px Arial";
                        ctx.fillStyle = '#fea711';
                        ctx.textAlign = 'center';
                        ctx.fillText(vDisplay_vEventName_Line1, 36, 60);

                      } else if (!vDisplay_vEventName_Line1 && vDisplay_vEventName_Line2) {
                        ctx.font = "bold 13px Arial";
                        ctx.fillStyle = '#fea711';
                        ctx.textAlign = 'center';
                        ctx.fillText(vDisplay_vEventName_Line2, 36, 60);
                      }
                    }
                    // shape
                    //ctx.fillStyle = 'rgba(0, 0, 200, 0.5)';
                    //ctx.fillRect(30, 30, 20, 20);
                    var dataURL = canvas.toDataURL(outputFormat || 'image/png');
                    callback.call(this, dataURL);
                  // Clean up
                    canvas = null;
              };
              img.src = url;
            };

            function convertImgToBase64_motion(url, vPosX, vPosY, vRotate, callback, outputFormat){
              var canvas = document.createElement('CANVAS');
              var ctx = canvas.getContext('2d');
              var img = new Image;
              img.crossOrigin = 'Anonymous';
              img.onload = function(){
                  canvas.height = img.height;
                  canvas.width = img.width;
                    //ctx.rotate(vRotate*Math.PI/180);
                    ctx.drawImage(img,vPosX,vPosY);
                    var dataURL = canvas.toDataURL(outputFormat || 'image/png');
                    callback.call(this, dataURL);
                  // Clean up
                    canvas = null;
              };
              img.src = url;
            };

            function convertImgToBase64(url, callback, outputFormat){
              var canvas = document.createElement('CANVAS');
              var ctx = canvas.getContext('2d');
              var img = new Image;
              img.crossOrigin = 'Anonymous';
              img.onload = function(){
                  canvas.height = img.height;
                  canvas.width = img.width;
                    ctx.drawImage(img,0,0);
                    var dataURL = canvas.toDataURL(outputFormat || 'image/png');
                    callback.call(this, dataURL);
                  // Clean up
                    canvas = null;
              };
              img.src = url;
            };
            function logMessage(context, vLogMessage) {
                if (websocket) {
                    var json = {
                        'event': 'logMessage',
                        'context': context,
                        'payload': {
                            'message': vLogMessage
                        }
                    };
                    websocket.send(JSON.stringify(json));
                }
            }
            // Set the state of a key
            function setState(context, inState) {
                if (websocket) {
                    var json = {
                        'event': 'setState',
                        'context': context,
                        'payload': {
                            'state': inState
                        }
                    };
                    websocket.send(JSON.stringify(json));
                }
            }
            function setImage (context, vAvatarBase64) {
              var json = {
                  'event': 'setImage',
                  'context': context,
                  'payload': {
                      'image': vAvatarBase64,
                      'target': DestinationEnum.HARDWARE_AND_SOFTWARE
                  }
                };
              websocket.send(JSON.stringify(json));
            }

            function connectElgatoStreamDeckSocket(inPort, inPluginUUID, inRegisterEvent, inInfo, inActionInfo) {
                pluginUUID = inPluginUUID;
                websocket = new WebSocket("ws://127.0.0.1:" + inPort);
                function registerPlugin(inPluginUUID) {
                    let json = { event: inRegisterEvent, uuid: inPluginUUID };
                    websocket.send(JSON.stringify(json));
                }
                websocket.onopen = function () {
                    registerPlugin(pluginUUID);
                };
                websocket.onmessage = function (evt) {
                    let jsonObj = JSON.parse(evt.data);
                    console.log("onmessage json: ", jsonObj);
                    let event = jsonObj["event"];
                    let action = jsonObj["action"];
                    let context = jsonObj["context"];
                    let actionInfo = jsonObj["inActionInfo"];
                    var jsonPayload = jsonObj['payload'] || {};
                    if (event == "keyDown") {
                        let jsonPayload = jsonObj["payload"];
                        let settings = jsonPayload["settings"];
                        let coordinates = jsonPayload["coordinates"];
                        let userDesiredState = jsonPayload["userDesiredState"];
                        KrabsDaysUntil.onKeyDown(context, settings, coordinates, userDesiredState);
                    } else if (event == "keyUp") {
                        let jsonPayload = jsonObj["payload"];
                        let settings = jsonPayload["settings"];
                        let coordinates = jsonPayload["coordinates"];
                        let userDesiredState = jsonPayload["userDesiredState"];
                        KrabsDaysUntil.onKeyUp(context, settings, coordinates, userDesiredState);
                    } else if (event == "willAppear") {
                        //let jsonPayload = jsonObj["payload"];
                        let settings = jsonPayload["settings"];
                        let coordinates = jsonPayload["coordinates"];
                        let userDesiredState = jsonPayload["userDesiredState"];
                        KrabsDaysUntil.onWillAppear(context, settings, coordinates, userDesiredState);
                    } else if (event == "willDisappear") {
                        var settings = jsonPayload['settings'];
                        var coordinates = jsonPayload['coordinates'];
                        KrabsDaysUntil.onWillDisappear(context, settings, coordinates);
                    } else if (event == "sendToPlugin") {
                        console.log("sendToPlugin received payload: ", jsonPayload);
                    } else if (event == "didReceiveSettings") {
                        console.log("didReceiveSettings received payload: ", jsonPayload);
                        let settings = jsonPayload["settings"];
                        let coordinates = jsonPayload["coordinates"];
                        let userDesiredState = jsonPayload["userDesiredState"];
                        KrabsDaysUntil.onWillAppear(context, settings, coordinates, userDesiredState);
                        }

                  };
                  websocket.onclose = function () {};
              };

        </script>
    </body>
</html>
